# Пользователи и проекты — требования к продакшену (Prod и Prod+)

> **Примечание:** Этот документ обновлен в соответствии с текущей архитектурой проекта. Используется терминология из схемы базы данных: `deliverables`, `deliverable_sections`, `source_documents`, `source_sections`, `custom_templates`, `ideal_templates`, `study_globals`. Подробнее см. документацию в `docs/00_MASTER_ARCH.md`, `docs/08_DATABASE_SCHEMA.md` и другие документы проекта.

Этот документ описывает, что должно быть реализовано в продакшене по теме «пользователи и проекты» для системы подготовки регуляторной и медицинской документации. Выделены два уровня зрелости: базовый PROD и расширенный PROD+ (enterprise-функциональность).

## 1\. Модель пользователей (Prod)

1.1. Базовая учётная запись пользователя

\- Уникальный логин (email) и пароль.  
\- Профиль: имя, фамилия, должность, организация (строкой), часовой пояс.  
\- Флаги: активен/деактивирован, требуется смена пароля.  
\- Минимальные требования к паролю и возможность его смены пользователем.

1.2. Регистрация и активация

\- Пригласительная модель: пользователь создаётся админом и получает письмо/ссылку для установки пароля.  
\- Возможность массовой загрузки пользователей (CSV/Excel) в административном интерфейсе.  
\- Блокировка/разблокировка пользователя без удаления истории действий.

1.3. Профиль пользователя

\- Страница «Мой профиль» с возможностью:  
• изменить отображаемое имя;  
• обновить должность и контактные данные;  
• изменить пароль.  
\- Отображение роли/ролей и списка проектов, к которым есть доступ.

## 2\. Модель проектов / исследований (Prod)

2.1. Сущность «Проект»/«Исследование»

\- Уникальный идентификатор проекта (project_id).  
\- Базовые поля:  
• код исследования (study_code) — уникален в рамках организации;  
• краткое название (title);  
• спонсор (sponsor) — текстовое поле;  
• терапевтическая область (therapeutic_area);  
• статус: `draft` / `active` / `archived`;  
• привязка к организации (organization_id) для мультитенантности.  
\- Владелец проекта (ответственный пользователь) через таблицу `project_members` с ролью `project_owner`.

2.2. Жизненный цикл проекта

\- Создание проекта пользователем с правом «create_project».  
\- Перевод по статусам (черновик → активный → на QC → подготовлен к подаче → архив):  
• с контролем, кто имеет право переводить между статусами;  
• с логированием изменений статуса.  
\- В архивном статусе проект доступен только для чтения, с пометкой «read-only».

2.3. Структура внутри проекта

\- **Исходные документы (source_documents):** Протокол, SAP, TLF, предыдущий CSR, IB и другие документы-источники, загруженные в проект.  
\- **Готовые документы (deliverables):** Документы, создаваемые на основе пользовательских шаблонов (custom_templates), например CSR.  
\- **Глобальный контекст (study_globals):** "Паспорт исследования" — ключевые факты (фаза, препарат, популяция), автоматически извлекаемые из протокола.  
\- Привязка всех документов к конкретному проекту через `project_id`.

## 3\. Связь «пользователи ↔ проекты» (Prod)

3.1. Членство в проекте

\- Явная модель membership:  
• project_member (таблица/связь user_id + project_id + роль в проекте);  
• пользователь видит только те проекты, в которых он участник.  
\- Роли внутри проекта (таблица `project_members`):  
• `project_owner` — полные права в рамках проекта (управление участниками, настройками);  
• `editor` — редактирование документов и секций проекта;  
• `viewer` — только чтение документов и секций.

3.2. Управление доступом на уровне проекта

\- Project Owner может:  
• добавлять/удалять участников проекта;  
• менять им роли в рамках проекта;  
• назначать нового владельца проекта.  
\- Встроенные проверки:  
• нельзя удалить последнего владельца проекта без передачи прав;  
• нельзя удалить участника, если у него незавершённые задачи (опционально, Prod+).

3.3. Список проектов для пользователя

\- Страница «Мои проекты»:  
• фильтрация по статусу (активные/архивные);  
• быстрый поиск по коду/названию исследования;  
• отображение роли пользователя в каждом проекте.  
\- Удобные сортировки: по дате обновления, по статусу, по спонсору.

## 4\. Роли и права доступа (Prod)

4.1. Глобальные роли системы

\- **Org Admin** (роль в таблице `organization_members`):  
• управление пользователями организации (создание/блокировка);  
• просмотр всех проектов организации (read-only или full, по политике);  
• настройка базовых конфигураций организации.  
\- **Member** (участник организации):  
• доступ только к проектам, где он участник (через `project_members`);  
• действия в рамках своих ролей в проектах (`project_owner`/`editor`/`viewer`).

4.2. Проверка прав на уровне API

\- Централизованная проверка:  
• при любом действии с проектом/документом проверяется membership и роль;  
• доступ к RAG-данным и AI-генерации строго в рамках проектов пользователя.  
\- Логирование отказов в доступе (для безопасности и аудита).

## 5\. Аудит и история действий (Prod)

5.1. Основной аудит

\- Логирование ключевых событий по пользователям и проектам:  
• создание/изменение/архивация проекта;  
• добавление/удаление участника, изменения ролей;  
• изменение статуса проекта.  
\- Хранение информации: кто, когда, что изменил.

5.2. Привязка к версиям документов

\- Для каждой версии CSR/документа — информация, кто её создал/обновил.  
\- Связка версий с пользователями и статусами проекта (например, версия создана на этапе in_QC).

## 6\. PROD+ — расширенная модель пользователей и проектов

6.1. Организации, тенанты и спонсоры

\- **Сущность «Организация» (organizations):**  
• мультитенантная архитектура — несколько независимых организаций в одной установке;  
• привязка пользователей через `profiles.organization_id` и `organization_members`;  
• привязка проектов через `projects.organization_id`;  
• изоляция данных между организациями через Row Level Security (RLS);  
• уникальный `slug` для URL-friendly идентификатора.  
\- **Спонсор** хранится как текстовое поле `sponsor` в таблице `projects` (может быть расширено до отдельной таблицы в Prod+).

6.2. Расширенный RBAC (role-based access control)

\- Более гибкая модель ролей:  
• глобальные роли (Org Admin, Sponsor Admin, Portfolio Manager);  
• проектные роли с детальными правами (можно редактировать только efficacy-разделы, но не safety и т.д.).  
\- Настройка ролей в административном интерфейсе с матрицей прав.

6.3. SSO и управление идентичностью

\- Поддержка SSO (SAML/OAuth2/OIDC) для корпоративных пользователей.  
\- SCIM или аналогичный механизм для синхронизации пользователей и групп с IdP.  
\- Маппинг групп/атрибутов IdP на роли и доступы в системе.

6.4. Иерархия проектов и портфели

\- Сущность «Портфель»/«Программа»:  
• группировка проектов по препарату, показанию, региону и т.п.;  
• права на уровень портфеля (например, Portfolio Manager видит все исследования по молекуле).  
\- Иерархия: Портфель → Проект → Документы.

6.5. Дополнительный аудит и политики

\- Тонкий аудит по действиям пользователей:  
• входы/выходы из системы;  
• попытки доступа без прав;  
• массовые изменения прав.  
\- Политики безопасности:  
• требования к длине и сроку жизни паролей (при локальных аккаунтах);  
• автоматическая блокировка при подозрительной активности.

6.6. SLA и разграничение окружений

\- Чёткое разделение PROD / UAT / DEV окружений:  
• пользователи и проекты могут быть изолированы по окружениям;  
• поддержка миграции проектов/шаблонов из UAT в PROD.  
\- Настройки квот: лимиты на число проектов, пользователей, объём хранилища на организацию.

6.7. Отчётность и аналитика по пользователям и проектам

\- Дашборды для админа/менеджмента:  
• активность пользователей (по ролям, по организациям);  
• количество и статус проектов по спонсорам/портфелям;  
• загрузка команд (projects per writer/biostat/RA).  
\- Экспорт отчётов в Excel/CSV для внутренней аналитики.

# Документы-источники — требования к продакшену (Prod и Prod+)

Этот документ описывает, что должно быть реализовано в продакшене по теме «Документы-источники» (протокол, SAP, TLF, предыдущий CSR и другие артефакты), которые используются как база для RAG, AI-ассистента и проверок консистентности/комплаенса. Выделены два уровня зрелости: базовый PROD и расширенный PROD+ (enterprise-функциональность).

## 1\. Общая концепция документов-источников

\- Документ-источник — любой файл/артефакт, который используется как нормативная или фактическая база для написания CSR и других регуляторных документов (протокол, SAP, TLF, предыдущий CSR, IB, SmPC, регуляторные письма и т.д.).  
\- Система должна уметь:  
• хранить такие документы с метаданными;  
• привязывать их к конкретным исследованиям/проектам;  
• обеспечивать просмотр/скачивание и контроль версий;  
• извлекать текст и подготавливать структурированные секции (source_sections) для RAG и QC-проверок.

## 2\. PROD — базовый уровень для документов-источников

2.1. Модель данных source_documents

\- Базовые поля (таблица `source_documents`):  
• `id` (UUID, уникальный идентификатор);  
• `project_id` (привязка к проекту);  
• `name` (название документа);  
• `doc_type` (тип документа): Protocol, SAP, CSR_Prev, IB и др.;  
• `input_type` (ENUM): `file` (загруженный файл) или `manual_entry` (ручной ввод);  
• `file_path` (путь к файлу в Supabase Storage, может быть NULL для `manual_entry`);  
• `status` (статус обработки): `uploading`, `processing`, `indexed`, `error`;  
• `template_id` (UUID, FK → custom_templates) — опциональный шаблон для классификации секций.  
\- **Версионирование документов:**  
• `parent_document_id` (ссылка на родительский документ);  
• `version_label` (метка версии, например "v1.0", "v2.1");  
• `is_current_version` (BOOLEAN, default: true) — **критически важно:** при генерации используются только документы с `is_current_version = TRUE`.  
\- **Метаданные парсинга:**  
• `parsing_metadata` (JSONB) — технические метрики (время обработки, количество страниц, ошибки);  
• `detected_tables_count` (INT) — количество таблиц, обнаруженных парсером;  
• `parsing_quality_score` (INT, 1-5) — ручная оценка качества парсинга;  
• `parsing_quality_comment` (TEXT) — комментарий к оценке качества.

2.2. Типы документов и обязательные для RAG

\- Минимальный набор типов:  
• protocol — протокол исследования;  
• sap — статистический план;  
• tlf — набор таблиц/листингов/фигур (может быть несколько файлов);  
• csr_prev — предыдущий CSR по этому исследованию или показанию;  
• ib — Investigator’s Brochure (опционально);  
• smpc — действующая версия SmPC/инструкции;  
• other — произвольные дополнительные источники.  
\- Возможность отметить, какие документы являются «ключевыми» для RAG/QC для данного проекта.

2.3. Загрузка и хранение файлов

\- UI и API для загрузки документов:  
• выбор типа документа и привязка к исследованию;  
• проверка расширения и базовой валидности (размер, тип файла);  
• отображение прогресса загрузки.  
\- Хранение:  
• файловая система или объектное хранилище (S3-совместимое);  
• формирование безопасного пути/ключа и недоступность файлов напрямую без авторизации.  
\- Возможность скачивания файлов пользователями с правом доступа к проекту.

2.4. Базовое версионирование

\- У одного типа документа (например, protocol) может быть несколько записей `source_documents` с разными `version_label` и флагом `is_current_version`.  
\- Флаги:  
• is_current (текущая актуальная версия для данного типа в рамках проекта);  
• is_rag_enabled (используется ли версия в RAG-индексе).  
\- В UI: список версий по типу документа с пометкой текущей и устаревших.

2.5. Привязка к RAG и структурный парсинг

\- После загрузки документа через Python AI Engine (`POST /api/v1/parse`):  
• выполняется **структурный парсинг** через DoclingParser (PDF/DOCX → Markdown с сохранением структуры);  
• документ разбивается на **секции** (source_sections) по заголовкам, а не на случайные чанки;  
• каждая секция сохраняется с полями: `section_number`, `header`, `content_markdown`, `content_text`, `page_number`;  
• создаются **эмбеддинги** (vector(1536)) для гибридного поиска;  
• выполняется **автоматическая классификация** секций по пользовательскому шаблону (если указан `template_id`).  
\- Возможность переиндексации (re-ingest) при обновлении документа.  
\- В UI для документа показывается статус: `uploading` → `processing` → `indexed` / `error`.

2.6. UI для работы с документами-источниками

\- Вкладка/раздел «Документы-источники»/«Sources» в пределах проекта:  
• таблица с колонками: Тип, Название, Версия, Статус, Язык, Загрузка, RAG-статус;  
• фильтры по типу, статусу, языку;  
• действия: открыть/скачать, пометить как текущую версию, включить/выключить для RAG.  
\- Мини-просмотр (preview) для текстовых форматов (встроенный viewer).

2.7. Права доступа (Prod)

\- Только участники проекта видят и могут скачивать документы.  
\- Право загрузки/удаления/смены статуса:  
• Project Owner и Editor — могут загружать новые версии и включать их в RAG;  
• Viewer — только просмотр/скачивание.  
\- Удаление документов либо запрещено, либо только «мягкое» (пометка archived, без физического удаления).

## 3\. PROD+ — расширенный уровень для документов-источников

3.1. Расширенная модель типов и структурированность

\- Поддержка более детализированных типов и подтипов:  
• Protocol (original, amendment, synopsis);  
• SAP (original, update);  
• CSR (draft, final, addendum);  
• Regulatory correspondence, briefing book и т.п.  
\- Маппинг типов на регуляторные артефакты (CTD-модуль, раздел ICH E3 и т.д.).

3.2. Продвинутое версионирование и статусная модель

\- Версионирование: major/minor (1.0, 1.1, 2.0) и явные связи «заменяет/заменён».  
\- Статусы документа:  
• draft → in_review → approved_for_RAG → effective → superseded → archived;  
• отдельные статусы для регуляторно утверждённых версий.  
\- История изменений статусов с указанием пользователя, даты и комментария.

3.3. Workflow согласования и e-signatures

\- Настраиваемый workflow согласования для ключевых типов (protocol, SAP, CSR_prev):  
• список согласующих ролей (statistician, medical writer lead, RA, QA);  
• шаги согласования и порог для перехода в approved_for_RAG.  
\- Поддержка электронной подписи (e-signature) для важных этапов (совместимость с 21 CFR Part 11 при необходимости).

3.4. Интеграция с DMS / eTMF / внешними репозиториями

\- Возможность хранить не сам файл, а ссылку на документ во внешней системе (Veeva, eTMF и т.п.):  
• хранение ключа/URL и метаданных;  
• опция синхронизации метаданных (версия, статус, дата утверждения).  
\- Поддержка гиперссылок и «открыть во внешней системе» прямо из UI проекта.

3.5. Расширенный пайплайн извлечения текста и структурирования

\- Поддержка извлечения текста для pdf/docx (через специализированные библиотеки/сервисы).  
\- Разметка текста на логические разделы (по оглавлению/структуре документа):  
• сопоставление разделов протокола с кодами CSR-секций;  
• создание структурированных секций (source_sections) с полной информацией о структуре документа (не только plain text, но и «section-aware» RAG).  
\- Лог ошибок извлечения (страницы/фрагменты, которые не удалось корректно обработать).

3.6. Мультиязычность и много-региональность

\- Метаданные по языку и региону обязательны для ключевых документов.  
\- Возможность привязать несколько версий одного документа для разных регионов (EU, EAEU, US).  
\- RAG и QC могут быть ограничены регионально: использование только релевантных документов для конкретной регуляторной версии CSR.

3.7. Безопасность и классификация документов

\- Классификация документов по уровню чувствительности:  
• public / internal / confidential / highly_confidential.  
\- Ограничение доступа по типу и уровню чувствительности (например, regulatory correspondence только для RA/QA).  
\- Шифрование хранения (at rest) для чувствительных типов (Prod+-уровень).

3.8. Мониторинг, диагностика и health-check RAG ingestion

\- Диагностический экран по документам-источникам:  
• статус извлечения (успешно/с ошибками);  
• количество чанков RAG по каждому документу;  
• последняя дата переиндексации;  
• сообщения об ошибках (например, не читаемый pdf).  
\- Возможность ручного триггера re-ingest по документу или группе документов.  
\- Алерты (например, при смене версии протокола без последующей переиндексации для RAG).

3.9. Отчётность и контроль использования документов-источников

\- Логи использования:  
• какие документы-источники использовались при генерации текстов AI;  
• какие версии были актуальны на момент подготовки конкретной версии CSR.  
\- Отчёт по проекту:  
• перечень всех документов-источников с версиями и статусами;  
• явно указанные «reference set» для QC и регуляторной подачи.

# Структура документа и редактор — требования к продакшену (Prod и Prod+)

Этот документ описывает, что должно быть реализовано в продакшене по теме «структура документа и редактор» для системы подготовки регуляторной и медицинской документации. Выделены два уровня зрелости: базовый PROD и расширенный PROD+ (enterprise-функциональность).

## 1\. Общая концепция структуры документа

\- В системе документ (CSR, Protocol, IB, SAP, TLF и т.д.) представляется как структурированный набор разделов/подразделов, соответствующих ICH E3 / ЕАЭС / внутренним шаблонам спонсора.  
\- Редактор работает не с «сырым» файлом, а с моделью: **deliverables** → **deliverable_sections** → **deliverable_section_history**.  
\- Каждый раздел имеет связь с пользовательским шаблоном (`custom_section_id`), заголовок, HTML-содержимое для редактора Tiptap, workflow-статус и историю изменений.  
\- **Двухуровневая система шаблонов:**  
• **Идеальные шаблоны (ideal_templates, ideal_sections)** — золотые стандарты структур, доступные всем пользователям;  
• **Пользовательские шаблоны (custom_templates, custom_sections)** — настройки на основе идеальных шаблонов для конкретных проектов или организаций.

## 2\. PROD — базовый уровень

2.1. Модель документа

\- **Сущность deliverables** (готовые документы, создаваемые на основе пользовательских шаблонов):  
• `id` (UUID);  
• `project_id` (привязка к проекту);  
• `template_id` (FK → custom_templates) — пользовательский шаблон, на основе которого создан документ;  
• `title` (отображаемое название);  
• `status`: `draft` (черновик) или `final` (финальная версия);  
• `created_at`, `updated_at`.  
\- **Сущность deliverable_sections** (секции готовых документов):  
• `id` (UUID);  
• `deliverable_id` (FK → deliverables);  
• `custom_section_id` (FK → custom_sections) — связь с секцией пользовательского шаблона;  
• `parent_id` (FK → deliverable_sections) — для иерархической структуры;  
• `content_html` (TEXT) — HTML контент для редактора Tiptap;  
• `status` (ENUM): `empty`, `draft_ai`, `in_progress`, `review`, `approved`;  
• `used_source_section_ids` (UUID[]) — массив ID исходных секций, использованных для генерации;  
• `locked_by_user_id`, `locked_at` — блокировка секции для предотвращения одновременного редактирования.  
\- **Примечание:** `deliverables` представляют готовые документы (Outputs), создаваемые на основе пользовательских шаблонов. Структура документа определяется через `custom_sections` пользовательского шаблона.

2.2. Структура разделов

\- **Структура определяется через пользовательские шаблоны (custom_templates, custom_sections):**  
• `custom_sections` содержат структуру секций документа (заголовки, порядок);  
• каждая `custom_section` может ссылаться на `ideal_section_id` (золотой стандарт);  
• `parent_id` позволяет строить иерархическую структуру (раздел/подраздел);  
• `order_index` определяет порядок отображения секций.  
\- **Секции готовых документов (deliverable_sections):**  
• создаются автоматически при создании `deliverable` на основе структуры `custom_sections`;  
• каждая `deliverable_section` связана с `custom_section_id`;  
• поддерживается иерархическая структура через `parent_id`;  
• в UI отображается как дерево разделов с возможностью переключения на плоский список.  
\- **Примечание:** Структура документа определяется через пользовательские шаблоны, которые могут быть глобальными для организации или специфичными для проекта.

2.3. История изменений секций (Audit Trail)

\- **Сущность deliverable_section_history** (автоматически создается через триггер):  
• `id` (UUID);  
• `section_id` (FK → deliverable_sections);  
• `content_snapshot` (TEXT) — снимок HTML контента на момент изменения;  
• `changed_by_user_id` (FK → auth.users) — пользователь, внесший изменение;  
• `change_reason` (TEXT) — причина изменения: "AI generation", "Manual edit", "Review feedback" и т.д.;  
• `created_at` (TIMESTAMPTZ) — время создания записи истории.  
\- **Механизм работы:**  
• триггер `deliverable_section_history_trigger` автоматически создает запись истории при изменении `content_html` или `status` секции;  
• актуальная версия хранится в `deliverable_sections.content_html`;  
• полная история доступна через `deliverable_section_history`;  
• возможность просмотра истории изменений и отката к предыдущей версии (создание новой версии на основе старой).

2.4. Базовый редактор текста (Tiptap)

\- Встроенный rich-text редактор **Tiptap** (Headless) для каждого раздела:  
• базовые стили: обычный текст, подзаголовки, жирный, курсив, подчёркивание;  
• списки (нумерованные/маркированные);  
• нативные таблицы Tiptap (создать/редактировать табличные блоки);  
• вставка простых ссылок/перекрёстных отсылок (как минимум в виде текстовых якорей).  
\- Контент хранится в формате HTML в поле `content_html` таблицы `deliverable_sections`.  
\- Поддержка автосохранения черновика при наборе текста.  
\- Возможность просмотреть «чистый» текст (plain) для копирования в Word при необходимости.

2.5. Навигация по структуре документа

\- В левой части интерфейса — панель структуры документа:  
• дерево разделов с кодами и заголовками;  
• индикация статуса раздела (черновик/ожидает ревью/одобрен и т.п. — опционально в Prod);  
• бэйджи с количеством Issues от Consistency & Compliance checker.  
\- Быстрый переход к разделу по клику.

2.6. Работа с шаблонами разделов (section templates)

\- Связка с системой шаблонов:  
• для каждого section_code может быть дефолтный текстовый шаблон (RU/EN);  
• пользователь может по кнопке «Заполнить по шаблону» создать новую версию раздела.  
\- В PROD редактор должен позволять:  
• применить шаблон один раз при создании раздела или новой версии;  
• отредактировать текст вручную после применения.

2.7. Права доступа в редакторе (Prod)

\- Участники проекта с ролью `editor` или `project_owner` могут редактировать разделы.  
\- `viewer` видит структуру и текст, но не может вносить изменения.  
\- **Блокировка секций для предотвращения одновременного редактирования:**  
• поля `locked_by_user_id` и `locked_at` в таблице `deliverable_sections`;  
• автоматическая разблокировка зависших блокировок через функцию `unlock_stale_deliverable_sections(timeout_minutes)`;  
• предупреждение в UI, если секция уже заблокирована другим пользователем.

2.8. Экспорт документа (базовый)

\- Экспорт всего документа в единый файл (Word/PDF) для обмена вне системы:  
• формирование текста по структуре (по order_index);  
• использование заголовков и подзаголовков по уровню вложенности;  
• простое форматирование без сложных стилей.  
\- Экспорт на уровне раздела (копировать/скачать только один раздел).

## 3\. PROD+ — расширенный уровень

3.1. Расширенная модель статусов разделов

\- Для разделов вводится статусная модель:  
• draft → in_review → approved → locked;  
• отдельные статусы для разделов, требующих регуляторного ревью (safety, efficacy summary и т.п.).  
\- Логирование переходов статусов (кто, когда, с каким комментарием).

3.2. Совместное редактирование и блокировки

\- Умное управление блокировками:  
• hard-lock: раздел может редактировать только один пользователь одновременно;  
• отображение, кто именно сейчас редактирует (имя, время начала);  
• возможность запросить разблокировку (например, если редактор давно не активен).  
\- В перспективе (расширенный PROD+):  
• near-real-time обновление текста (простая коллаборация),  
• предупреждения о конфликтных сохранениях.

3.3. Тонкое версионирование и сравнение версий

\- Версионирование на уровне раздела:  
• явные версии с метками (v0.1, v0.2, v1.0 и т.п.);  
• указание типа изменения (minor/major, редакторские правки vs субстантивные изменения).  
\- Встроенный diff для двух версий:  
• подсветка добавленного/удалённого текста;  
• просмотр изменений по абзацам.  
\- Возможность сформировать «change log» по разделу или по всему документу.

3.4. Режим предложений / track changes

\- Режим предложений (suggestion mode):  
• изменения отдельных пользователей оформляются как «предложенные»;  
• владелец раздела/документа может принять/отклонить изменения.  
\- Поддержка базового track changes для интеграции с Word:  
• экспорт с пометкой изменений (вкладка Review в Word);  
• (дополнительно) импорт обратно/частичное сопоставление.

3.5. Глубокая интеграция с Consistency & Compliance checker

\- В редакторе отображаются Issues по разделу:  
• подсветка проблемных фрагментов в тексте;  
• боковая панель со списком Issues и кратким описанием.  
\- Возможность перехода от Issue к месту в тексте и обратно.  
\- Кнопки быстрого применения auto-fix (там, где это возможно).

3.6. AI-инструменты внутри редактора

\- Интеграция AI-ассистента в редактор:  
• генерация начального текста по шаблону и RAG-контексту;  
• переформулировка, упрощение, перевод, подгонка под стиль спонсора;  
• локальные подсказки по улучшению ясности или полноты раздела.  
\- Управление версиями при использовании AI:  
• пометка версий, созданных/изменённых с помощью AI;  
• сохранение запроса (prompt) и контекста, на основе которых был сгенерирован текст.

3.7. Расширенные возможности форматирования

\- Более богатый набор форматирования:  
• стили, приближенные к корпоративному шаблону Word;  
• управление отступами, нумерацией, многоуровневыми списками;  
• улучшенная работа с таблицами (объединение ячеек, стили заголовков).  
\- Поддержка вставки и базового отображения формул, схем, таблиц из TLF (как минимум текстительно, затем — более богато).

3.8. Структурные шаблоны и кастомные структуры

\- Возможность создавать пользовательские структуры документа на основе базового шаблона:  
• включать/выключать разделы;  
• добавлять свои разделы/подразделы с собственными code/title;  
• сохранять кастомный шаблон для будущих проектов спонсора.  
\- Управление несколькими вариантами структуры под разные регуляторы (EMA/FDA/EAEU).

3.9. Улучшенный экспорт/импорт

\- Экспорт в Word с сохранением структуры и стилей:  
• разделы → Word заголовки (Heading 1/2/3);  
• таблицы и списки — в соответствии с корпоративным шаблоном.  
\- Возможность ограниченного импорта изменений из Word-документа:  
• сопоставление разделов по заголовкам и коду;  
• подмена текста в разделе с созданием новой версии.  
\- Экспорт PDF для финального просмотра/рассылки.

3.10. Роли и workflow вокруг разделов и документа

\- Дополнительные роли и права на уровне раздела:  
• ответственный за раздел (section owner);  
• reviewer (может комментировать и менять статус, но не текст);  
• approver (утверждает раздел).  
\- Workflow согласования:  
• настройка маршрутов ревью для критичных разделов (safety, efficacy, synopsis);  
• требования к статусу разделов перед переводом всего документа в статус ready_for_submission.

# AI-ассистент — требования к продакшену (Prod и Prod+)

Этот документ описывает, что должно быть реализовано в продакшене по теме «AI-ассистент» для системы подготовки регуляторной и медицинской документации. Выделены два уровня зрелости: базовый PROD и расширенный PROD+ (enterprise-функциональность).

## 1\. Общая концепция AI-ассистента

\- AI-ассистент помогает авторам быстрее создавать и улучшать текст разделов CSR и других документов, используя RAG-контекст (протокол, SAP, TLF, прошлые CSR и др.) и шаблоны.  
\- Главный принцип: не выдумывать данные, опираться на источники, обеспечивать трассируемость и контроль.  
\- Ассистент не заменяет ответственного автора, а предлагает варианты текста и подсказки.

## 2\. PROD — базовый уровень AI-ассистента

2.1. Базовые сценарии использования

\- **Генерация черновика текста для секции (deliverable_section):**  
• на основе Template Graph (custom_mappings / ideal_mappings) и исходных секций документов (source_sections);  
• автоматическое использование глобального контекста исследования (study_globals);  
• вызов через Python API `POST /generate` с параметрами: `project_id`, `target_section_id`, `deliverable_id`;  
• результат сохраняется в `deliverable_sections.content_html` со статусом `draft_ai`.  
\- Переформулировка/улучшение существующего текста:  
• сделать текст более ясным/формальным/лаконичным;  
• адаптировать под регуляторный стиль (без маркетинга).  
\- Локальные подсказки внутри секции:  
• предложить формулировку для предложения/абзаца на основе контекста.

2.2. Минимальный API и контракт

\- Единый backend-эндпоинт (например, /api/v1/ai/generate-section-text):  
• вход: study_id, section_id, prompt (опционально), параметры генерации (max_tokens, temperature);  
• выход: generated_text, model_name, timestamp.  
\- Чёткая валидация:  
• проверка доступа пользователя к проекту и секции;  
• ограничения по размерам prompt и частоте вызовов (baseline rate limiting).

2.3. Интеграция с Template Graph и структурным RAG

\- **Template Graph Architecture:**  
• система использует двухуровневую архитектуру шаблонов (ideal_templates / custom_templates);  
• правила маппинга (custom_mappings / ideal_mappings) определяют, какие исходные секции использовать для генерации целевой секции;  
• правила содержат инструкции для AI (`instruction`) — например, "change future tense to past tense".  
\- **Структурный RAG (вместо простого чанкинга):**  
• исходные документы парсятся структурно (по заголовкам) в `source_sections`;  
• при генерации используются только актуальные версии документов (`is_current_version = TRUE`);  
• для каждого маппинга находятся соответствующие `source_sections` с фильтром по `custom_section_id`;  
• глобальный контекст (study_globals) автоматически добавляется в системный промпт.  
\- **Гибридный поиск (как страховка):**  
• векторный поиск по эмбеддингам используется для поиска информации, не попавшей в жесткий маппинг;  
• порог similarity: 0.85 для семантического поиска.

2.4. UX в редакторе (Prod)

\- Кнопка «Сгенерировать с помощью AI» в редакторе раздела:  
• при нажатии: отправка текущего текста (как контекста) и дополнительных инструкций в AI;  
• индикация загрузки и предсказуемый результат.  
\- Отображение результата:  
• минимум: замена текста раздела на сгенерированный (с возможностью отмены);  
• желательно: опция «добавить» (append) вместо замены.  
\- Боковая панель «AI Assistant»:  
• можно задать произвольный вопрос по разделу или исследованию;  
• ответ показывается как отдельный блок, пользователь вручную копирует нужные фрагменты.

2.5. Логирование и трассируемость (Prod)

\- **Audit Trail через deliverable_section_history:**  
• каждая генерация создает запись истории с `change_reason = "AI generation"`;  
• сохраняется снимок контента (`content_snapshot`), пользователь (`changed_by_user_id`) и время (`created_at`).  
\- **Отслеживание использованных источников:**  
• массив `used_source_section_ids` в `deliverable_sections` содержит ID всех исходных секций, использованных для генерации;  
• позволяет отследить, какие части протокола/SAP были использованы для создания секции.  
\- **Логирование вызовов AI в Python сервисе:**  
• project_id, deliverable_section_id, user_id;  
• фактический prompt (или его безопасная версия);  
• модель (model_name) и timestamp;  
• флаг успех/ошибка, код ошибки.  
\- Важно: лог не должен содержать излишне детальную медицинскую PII/PHI-информацию, если это противоречит политике.  
\- Возможность посмотреть историю изменений секции через `deliverable_section_history` (кто, когда, с каким результатом).

2.6. Базовая безопасность и ограничения

\- Чёткое разграничение использования AI:  
• только авторизованные пользователи проекта;  
• запрет генерации для несуществующих/чужих исследований.  
\- Конфигурация модели и API-ключей в защищённом хранилище (без жёсткого кодирования в репозитории).  
\- Базовое rate limiting, чтобы избежать случайной перегрузки или misuse.

2.7. Принципы качества ответов (Prod)

\- Настройки prompt-шаблонов должны задавать модельное поведение:  
• не выдумывать числовые значения и факты — использовать только предоставленный контекст;  
• явно обозначать отсутствие данных: «данные не представлены в доступном контексте»;  
• избегать маркетинговых формулировок и оценочных суждений.  
\- Для ключевых разделов (synopsis, efficacy, safety) использовать специализированные prompt-шаблоны.

## 3\. PROD+ — расширенный уровень AI-ассистента

3.1. Расширенная матрица сценариев

\- Дополнительные режимы работы AI:  
• «Суммаризация» исходных данных/таблиц в регуляторный текст;  
• «Объясни» — краткие объяснения сложных статистических концепций для внутр. команд;  
• «Сравнение версий» — подсказки по смысловым изменениям между v0.3 и v0.4 текста;  
• «Перевод RU ↔ EN» с сохранением терминологии.  
\- Возможность выбирать режим в UI (dropdown или отдельные кнопки).

3.2. Глубокая интеграция с шаблонами и правилами

\- Связка AI и template-движка:  
• генерация текста строго в структуру шаблона с плейсхолдерами;  
• подстановка полей (study_code, phase, N, endpoints) из контекста вместо свободного текста.  
\- Интеграция с Consistency & Compliance checker:  
• AI учитывает замечания checker’а и предлагает исправления, удовлетворяющие правилам.  
• Режим «исправить текст с учётом QC-issues».

3.3. Управление моделями и провайдерами

\- Конфигурация моделей:  
• поддержка нескольких моделей (например, internal LLM, OpenAI, локальные модели);  
• выбор модели по организации/проекту/типу задачи.  
\- Политики использования:  
• возможность отключить внешние провайдеры для особо чувствительных клиентов;  
• маршрутизация запросов (для одних задач — большая модель, для других — более дешёвая/быстрая).

3.4. Продвинутый контроль качества и feedback loop

\- Интерфейс для обратной связи по ответам AI:  
• полезно / бесполезно;  
• флажок «неправильные данные» / «слишком общо» / «слишком смело».  
\- Использование feedback для настройки prompt-шаблонов и выбора модели:  
• статистика по полезности ответов;  
• выявление сценариев, где AI лучше отключить или ужесточить правила.  
\- В перспективе — дообучение или настройка моделей на основе обезличенных данных и фидбэка.

3.5. Расширенный аудит и соответствие регуляторным требованиям

\- Полный audit trail по AI-вызовам:  
• кто, когда, для какого раздела запустил ассистента;  
• какой prompt-шаблон и модель были использованы;  
• ссылка на сохранённый результат (SectionVersion).  
\- Отчётность для QA/RA:  
• возможность выгрузить список всех мест, где использовался AI при подготовке CSR;  
• опциональный флаг в документе: разделы, существенно сформированные при участии AI.

3.6. Ролевые ограничения и политики использования

\- Дополнительные настройки:  
• разрешить/запретить использование AI для конкретных ролей (например, только writers/biostats);  
• ограничить использование AI на определённых этапах (например, запрещено после статуса ready_for_submission).  
\- Политики на уровне организации/спонсора:  
• отключить AI полностью или только внешних поставщиков;  
• разрешить использование AI только в dev/UAT окружении.

3.7. Продвинутая работа с контекстом и персонализация

\- Более умный RAG-слой:  
• семантический поиск по секциям (source_sections) через эмбеддинги и pgvector;
• приоритизация более релевантных секций для разных типов запросов (efficacy/safety/RA) через Template Graph маппинги.
\- Персонализация подсказок под стиль спонсора:  
• хранение «style guide»/preferred wording;  
• настройка AI на использование конкретных формулировок и терминологии.

3.8. Интеграция в CI/QC-процессы

\- AI как часть pipeline подготовки документа:  
• возможность запускать пакетные генерации для типовых разделов по триггеру (создание документа);  
• интеграция с CI: запрет автоматического изменения текста без review человеком.  
\- Отчёты о том, сколько времени и правок сэкономлено благодаря AI (метрики эффективности).

# RAG — требования к продакшену (Prod и Prod+)

Этот документ описывает, что должно быть реализовано в продакшене по теме «RAG» (Retrieval-Augmented Generation) для системы подготовки регуляторной и медицинской документации. Выделены два уровня зрелости: базовый PROD и расширенный PROD+ (enterprise-функциональность).

## 1\. Общая концепция RAG в продукте

\- Цель RAG: подавать LLM только релевантный, проверенный контекст из документальных источников (протокол, SAP, TLF, предыдущий CSR и др.) и тем самым:  
• снижать риск галлюцинаций и выдуманных данных;  
• сохранять консистентность выводов с исходными материалами;  
• позволять объяснить, откуда взята та или иная формулировка.  
\- Вся логика RAG должна быть прозрачной, управляемой и проверяемой (auditable).

## 2\. PROD — базовый уровень RAG

2.1. Модель данных для секций исходных документов (source_sections)

\- **Сущность source_sections** (структурное представление вместо простых чанков):  
• `id` (UUID);  
• `document_id` (FK → source_documents);  
• `section_number` (TEXT) — номер секции, извлеченный из заголовка (например, "3.1.2");  
• `header` (TEXT) — заголовок секции;  
• `page_number` (INT) — номер страницы в исходном документе;  
• `content_text` (TEXT) — чистый текст для поиска (без разметки);  
• `content_markdown` (TEXT) — текст с разметкой таблиц (для LLM);  
• `embedding` (vector(1536)) — векторное представление секции для семантического поиска;  
• `custom_section_id` (FK → custom_sections) — связь с секцией пользовательского шаблона (классификация);  
• `classification_confidence` (FLOAT, 0.0-1.0) — уверенность автоматической классификации;  
• `bbox` (JSONB) — координаты текста для подсветки в PDF.  
\- **Индексы:**  
• по `document_id`;  
• по `custom_section_id`;  
• векторный индекс (IVFFlat) для `embedding`;  
• GIN индекс для `bbox` (JSONB).

2.2. Структурный парсинг документов-источников (ingestion)

\- **Структурный парсинг через Python AI Engine:**  
• по загрузке `source_document` через Next.js Server Action вызывается Python API `POST /api/v1/parse`;  
• парсинг выполняется асинхронно в фоне (BackgroundTasks);  
• используется **DoclingParser** для конвертации PDF/DOCX в Markdown с сохранением структуры;  
• документ разбивается на **секции** по заголовкам (H1, H2, H3, ...), а не на случайные чанки;  
• извлекаются номера секций, уровни иерархии, таблицы (в формате Markdown).  
\- **Результат:**  
• секции сохраняются в таблицу `source_sections` с полной структурной информацией;  
• создаются эмбеддинги для гибридного поиска;  
• выполняется автоматическая классификация секций по пользовательскому шаблону (если указан `template_id`);  
• статус обработки хранится в `source_documents.status`: `uploading` → `processing` → `indexed` / `error`.

2.3. Структурное разбиение документов

\- **Структурная стратегия разбиения (вместо простого чанкинга):**  
• разбиение по заголовкам (H1, H2, H3, ...) с сохранением иерархии;  
• автоматическое извлечение номеров секций из заголовков (например, "3.1.2");  
• сохранение контекста (номер страницы, координаты текста в `bbox`);  
• таблицы сохраняются в формате Markdown внутри секций.  
\- **Требование к PROD:**  
• чёткая, повторяемая логика структурного парсинга;  
• понятный порядок следования секций через `section_number` и `page_number`;  
• сохранение полной структуры документа для точного маппинга через Template Graph.

2.4. Template Graph ретривер (структурный маппинг)

\- **На уровне PROD используется Template Graph Architecture:**  
• правила маппинга (custom_mappings / ideal_mappings) определяют, какие исходные секции использовать;  
• для целевой секции находятся все правила, где `target_custom_section_id = custom_section.id`;  
• для каждого правила находятся соответствующие `source_sections` с фильтром по `custom_section_id`;  
• **критически важно:** используются только документы с `is_current_version = TRUE`.  
\- **Гибридный поиск (как страховка):**  
• если жесткий маппинг не нашел исходные данные, выполняется векторный поиск;  
• поиск по cosine similarity с порогом 0.85;  
• используется для сносок, приложений и дополнительных разделов, не привязанных к шаблону.  
\- **Функция сборки контекста:**  
• собирает текст из найденных `source_sections` (используется `content_markdown`, если доступен);  
• добавляет глобальный контекст из `study_globals` (Паспорт исследования);  
• формирует структурированный промпт с инструкциями трансформации из маппингов.

2.5. Использование Template Graph и RAG в AI-ассистенте (Prod)

\- **Каждый вызов AI-ассистента для генерации секции (deliverable_section):**  
• через Python API `POST /generate` с параметрами: `project_id`, `target_section_id`, `deliverable_id`;  
• сервис `Writer.generate_section()` находит правила маппинга для целевой секции;  
• находит исходные секции документов проекта с фильтром `is_current_version = TRUE`;  
• собирает глобальный контекст из `study_globals` (Паспорт исследования);  
• формирует промпты: System (роль + глобальные данные) + User (исходные данные + инструкции трансформации);  
• вызывает LLM и сохраняет результат в `deliverable_sections.content_html` со статусом `draft_ai`;  
• сохраняет ID использованных исходных секций в `used_source_section_ids`;  
• создает запись истории в `deliverable_section_history` с причиной "AI generation".  
\- Важно: вся логика RAG и Template Graph выполняется централизованно в Python backend и не дублируется на фронте.

2.6. Диагностика и просмотр RAG-данных (Prod)

\- **Диагностический просмотр через UI проекта:**  
• вкладка "Источники" показывает список `source_documents` с их статусами обработки;  
• для каждого документа можно просмотреть список `source_sections` с заголовками и номерами секций;  
• отображается информация о классификации секций (связь с `custom_section_id` и уверенность классификации).  
\- **Просмотр использованных источников для секции:**  
• в редакторе секции отображается массив `used_source_section_ids`;  
• можно перейти к исходным секциям, использованным для генерации;  
• отображается связь с правилами маппинга через Template Graph.  
\- В UI:  
• панель «Источники» для проекта: список документов и их секций;  
• упрощённый просмотр — чтобы medical writer мог понять, какие исходные данные использовались для генерации.

2.7. Безопасность и права доступа (Prod)

\- **Доступ к source_sections:**  
• только через backend-API при наличии прав на проект (проверка через `has_project_access`);  
• Row Level Security (RLS) на таблице `source_sections` обеспечивает изоляцию данных;  
• нет прямых запросов к таблице без проверки авторизации.  
\- **AI-ассистент использует только секции документов проектов, к которым у пользователя есть доступ:**  
• проверка доступа выполняется на уровне Python API перед генерацией;  
• используются только документы с `is_current_version = TRUE` для актуальности данных.

## 3\. PROD+ — расширенный уровень RAG

3.1. Семантический поиск и эмбеддинги

\- Добавление слоя эмбеддингов:  
• хранение векторных представлений чанков (например, в pgvector / ES / отдельном векторном хранилище);  
• обновление эмбеддингов при изменении текста чанка.  
\- Семантический ретривер:  
• поиск по похожести для конкретного запроса (prompt’а и/или описания задачи);  
• комбинирование семантического и метаданных-фильтра (study_id, source_type, язык, регион).

3.2. Продвинутое ранжирование и отбор контекста

\- Ранжирование чанков:  
• по релевантности для конкретного запроса/типа секции;  
• использование нескольких стратегий (BM25 + эмбеддинги).  
\- Отбор контекста:  
• ограничение объёма (tokens budget) с учётом длины prompt’а и лимитов модели;  
• группировка чанков по документам/разделам для сохранения контекста.  
\- Возможность настраивать стратегию per use-case (synopsis vs safety vs efficacy).

3.3. Структурный RAG через Template Graph

\- **Разметка секций с учётом структуры исходных документов:**  
• поля: `section_number`, `header`, `page_number` в `source_sections`;  
• автоматическая классификация секций по пользовательскому шаблону через `custom_section_id`;  
• правила маппинга (custom_mappings / ideal_mappings) определяют, какие исходные секции использовать для целевой секции.  
\- **Для AI-генерации секции EFFICACY_PRIMARY:**  
• находятся правила маппинга, где `target_custom_section_id` соответствует секции EFFICACY_PRIMARY;  
• для каждого правила находятся исходные секции с соответствующим `custom_section_id` (например, секции протокола с описанием primary endpoint);  
• выбираются только актуальные версии документов (`is_current_version = TRUE`).

3.4. Региональность и языки

\- **Поддержка мульти-языковых RAG-индексов:**  
• язык секции может быть определен из метаданных документа (в будущем);  
• приоритет секций на языке документа, который пишется.  
\- **Региональные источники:**  
• возможность ограничить RAG-контекст документами для конкретного региона (EU/FDA/EAEU) через фильтрацию по `doc_type` или метаданным;  
• поддержка параллельных версий документов через версионирование (`parent_document_id`, `version_label`) и выбор актуальной версии через `is_current_version`.

3.5. Версионирование документов и воспроизводимость

\- **Версионирование исходных документов:**  
• привязка `source_sections` к версиям документов через `source_documents.parent_document_id` и `version_label`;  
• флаг `is_current_version` определяет, какая версия документа используется при генерации;  
• возможность увидеть, на основе каких версий источников был сформирован текст CSR через `used_source_section_ids`.  
\- **Audit Trail для AI-вызова:**  
• массив `used_source_section_ids` в `deliverable_sections` содержит ID всех использованных исходных секций;  
• запись истории в `deliverable_section_history` с причиной "AI generation" и снимком контента;  
• воспроизводимость результата (можно восстановить контекст, который видела модель, через `used_source_section_ids`).

3.6. Мониторинг и качество RAG

\- Метрики и мониторинг:  
• количество чанков по проекту/типам документов;  
• доля документов, полностью не проиндексированных;  
• среднее время ingestion.  
\- Качество контекста:  
• ручная разметка и фидбэк: «контекст полезен/не полезен»;  
• выявление «шумных» чанков и пересмотр стратегии чанкинга/фильтрации.

3.7. Управляемость и конфигурация RAG

\- Настройки для админа/организации:  
• какие типы документов участвуют в RAG (protocol/sap/tlf/ib/smpc/etc.);  
• приоритеты источников (например, всегда брать протокол и SAP, TLF — опционально);  
• лимиты на количество чанков/объём контекста на запрос.  
\- Возможность отключить RAG для особо конфиденциальных проектов (использовать только шаблоны и ручной ввод).

3.8. Интеграция с QC и AI-ассистентом

\- **Структурный RAG как общий слой для AI и Consistency & Compliance checker:**  
• checker использует те же `source_sections` для сверки чисел и формулировок;  
• AI-ассистент и checker опираются на согласованный, версионированный контекст через Template Graph;  
• используется единая "истина" по числам и формулировкам из актуальных версий документов (`is_current_version = TRUE`).  
\- **Диагностика «почему AI написал это так»:**  
• отображение `used_source_section_ids` — список исходных секций, использованных при генерации конкретной версии текста;  
• связь с Issues QC (если контекст не покрывает требуемые данные);  
• возможность просмотреть исходные секции через ссылки в UI редактора.

3.9. Безопасность и соответствие требованиям

\- Классификация RAG-данных:  
• пометка чувствительных чанков (например, с потенциальной PII/PHI);  
• опциональная фильтрация таких чанков из контекста для внешних моделей.  
\- Политики по retention/удалению:  
• срок хранения RAG-данных после завершения проекта;  
• безопасное удаление чанков/индексов по запросу спонсора или в соответствии с политиками организации.

# Consistency / QC — требования к продакшену (Prod и Prod+)

Этот документ описывает, что должно быть реализовано в продакшене по теме «Consistency / QC» (Quality Control текстов и данных) для системы подготовки регуляторной и медицинской документации. Выделены два уровня зрелости: базовый PROD и расширенный PROD+ (enterprise-функциональность).

## 1\. Общая концепция Consistency / QC

\- Цель модуля Consistency / QC — находить несоответствия между текстом документа и исходными данными (протокол, SAP, TLF, RAG-источники), а также между разными разделами документа, и помогать авторам оперативно их исправлять.  
\- Базовый объект системы QC — Issue (найденная проблема) с контекстом, серьёзностью и историей обработки.  
\- QC должен быть воспроизводимым, аудируемым и настраиваемым под спонсора/регулятора.

## 2\. PROD — базовый уровень

2.1. Объекты: Rule, QCRun, Issue

\- Rule (правило):  
• уникальный идентификатор и человекочитаемое имя;  
• категория (numeric, text, structural, regulatory_basic);  
• уровень серьёзности по умолчанию (minor / major / critical);  
• описание, что именно проверяется.  
\- QCRun (запуск проверки):  
• id, document_id или section_id;  
• тип запуска (per_section, full_document, manual);  
• список правил/пакетов, которые применялись;  
• статус (running / completed / failed), timestamp, инициатор.  
\- Issue (проблема):  
• id, qc_run_id, study_id, document_id, section_id;  
• rule_id, категория, серьёзность;  
• краткое описание (summary) и детальное сообщение (details);  
• позиция в тексте (offset/фрагмент);  
• источник сравнения (TLF, Protocol, SAP, CSR_prev);  
• статус (open / resolved / wont_fix); кто и когда изменил статус.

2.2. Базовые классы правил для PROD

\- Numeric consistency:  
• сверка N и % по популяциям (ITT/FAS/PP/Safety) между текстом и TLF;  
• проверка простых процентов (N и % согласованы);  
• p-value и CI соответствуют таблицам.  
\- Structural consistency:  
• наличие всех обязательных разделов документа;  
• корректность ссылок на таблицы/рисунки (существование по номеру);  
• простая проверка ссылок на другие разделы (если реализовано на уровне структуры).  
\- Terminology / style (минимум):  
• выявление явно нежелательных маркетинговых формулировок в научном тексте.  
\- Regulatory basic:  
• наличие ключевых разделов, требуемых ICH E3 / ЕАЭС (уровень «есть/нет»).

2.3. Запуск QC (Prod)

\- Сценарии запуска:  
• ручной запуск «Проверить раздел» из редактора;  
• ручной запуск «Проверить весь документ» из панели документа.  
\- Для PROD достаточно синхронных запусков для отдельных разделов и простого асинхронного запуска для полного документа (через очередь задач или фоновые задания).

2.4. UI: панель Consistency / QC (Prod)

\- Отдельная панель QC на уровне документа:  
• фильтрация Issues по разделам, категориям и серьёзности;  
• список Issues с кратким описанием и статусом;  
• счётчик проблем по уровням серьёзности.  
\- В редакторе раздела:  
• индикация числа Issues по разделу;  
• мини-список проблем + переход к соответствующим фрагментам.  
\- Важно: PROD-уровень может отображать Issues как «ссылки на текст» без сложного diff.

2.5. Управление Issue (Prod)

\- Статусы и действия:  
• open → resolved → (опционально) re-open;  
• open → wont_fix (с обязательным комментарием).  
\- Права:  
• автор/редактор может менять статус у Issues по своим разделам;  
• Viewer видит Issues, но не может их менять.  
\- Логировать каждое изменение статуса (кто, когда, какой комментарий).

2.6. Интеграция QC с RAG и документами-источниками

\- Правила QC для чисел и фактов используют те же данные, что и RAG (`source_sections` / `source_documents`):  
• единая «истина» по числам и формулировкам;  
• минимизация дублирования логики извлечения.  
\- В Issue указывать ссылку на источник (тип документа и, по возможности, конкретную таблицу или раздел).

2.7. Audit trail и отчётность (Prod)

\- Хранить историю QCRun по документу:  
• кто и когда запускал QC;  
• сколько Issues найдено/закрыто;  
• какие правила применялись.  
\- Базовый отчёт:  
• экспорт списка Issues для документа в Excel/CSV для внутреннего QA.

## 3\. PROD+ — расширенный уровень

3.1. Расширенный rule engine и rule packs

\- Rule engine:  
• хранение правил в конфигурируемом виде (метаданные + код/DSL);  
• возможность включать/выключать правила и настраивать пороги (tolerance, rounding и т.п.);  
• версионирование правил (rule_version) и связка с QCRun.  
\- Rule packs:  
• базовый (ICH E3 core);  
• региональные (EAEU, FDA, EMA);  
• спонсорские (preferred wording, фирменные требования);  
• включение пакетов на уровне организации/спонсора/проекта.

3.2. Дополнительные классы проверок

\- Расширенные numeric & logical rules:  
• проверка согласованности p-value и словесных формулировок «statistically significant / not significant»;  
• контроль, что primary endpoint не «перекрашен» в secondary/exploratory.  
\- Cross-section consistency:  
• отсутствие противоречий между synopsis и основными разделами;  
• согласованность statement’ов по безопасности/эффективности в разных частях документа.  
\- Регуляторные правила высокого уровня:  
• наличие обязательных блоков текста в ключевых разделах;  
• проверки на уровень раскрытия информации (например, описание missing data handling).

3.3. Auto-fix и AI-подсказки

\- Для части правил QC — поддержка auto-fix:  
• предложение новой формулировки или числового значения на основе golden-данных;  
• возможность применить исправление одним кликом (создаётся новая версия текста).  
\- Интеграция с AI-ассистентом:  
• сценарий «исправить текст с учётом Issues данного раздела»;  
• AI предлагает новый текст, проходящий QC-правила, автор принимает/редактирует.

3.4. Ролевые представления и workflow QC

\- Разные виды представления QC для ролей:  
• Medical writer view — фокус на текстовых и числовых несоответствиях;  
• Statistician view — акцент на p-value, CI, популяции и модели;  
• RA/QA view — регуляторные и структурные проверки.  
\- Workflow QC:  
• возможность назначать Issues конкретным пользователям (assignee);  
• этапы QC (internal writer QC → stats QC → RA/QA review) с индикаторами прогресса.

3.5. Интеграция с CI/CD документа

\- QC как «gate» для статуса документа:  
• переход документа в ready_for_submission только при выполнении QC-критериев (например, 0 critical, ≤ X major);  
• возможность задать политику на уровне организации/спонсора.  
\- Интеграция с процессом версионирования:  
• привязка QCRun и Issues к версиям документа;  
• отчёт «QC-статус на момент версии v1.0».

3.6. Метрики и дашборды качества

\- Дашборды для QC и руководства:  
• количество Issues по проектам/документам/типам правил;  
• среднее время закрытия Issues;  
• динамика качества (снижение количества Issues от версии к версии).  
\- Отчётность по портфелю:  
• статус QC по всем активным исследованиям для спонсора;  
• выделение документов/проектов с повышенным риском (много критичных Issues).

3.7. Feedback loop и улучшение правил

\- Сбор обратной связи по Issues и правилам:  
• пометка Issues как «false positive»;  
• возможность оставить комментарий к правилу.  
\- Использование feedback:  
• корректировка порогов и логики правил;  
• при наличии ML/LLM-компонент — обучение/тонкая настройка моделей на основе отмеченных ошибок.

3.8. Соответствие требованиям инспекций и audit trail

\- Полный audit trail QC-деятельности:  
• история всех запусков QC и изменений Issues;  
• кто, когда, с каким результатом выполнял QC;  
• аргументация «wont_fix» для спорных несоответствий.  
\- Экспорт QC-пакета для инспекций:  
• PDF/Excel-отчёт с резюме всех Issues и их статусом;  
• ссылки на соответствующие версии документа и источники данных.

# Экспорт и формат — требования к продакшену (Prod и Prod+)

Этот документ описывает, что должно быть реализовано в продакшене по теме «Экспорт и формат» для системы подготовки регуляторной и медицинской документации. Выделены два уровня зрелости: базовый PROD и расширенный PROD+ (enterprise-функциональность).

## 1\. Общая концепция экспорта и форматов

\- Внутри системы документ (например, CSR) хранится в структурированном виде: разделы, версии, метаданные, связка с шаблонами.  
\- Экспорт обеспечивает преобразование этой структуры в внешние форматы (Word, PDF и др.) с сохранением иерархии, стилей и, по возможности, функционала (оглавление, нумерация таблиц/рисунков).  
\- Форматирование должно быть предсказуемым и соответствовать корпоративным/регуляторным ожиданиям.

## 2\. PROD — базовый уровень «Экспорт и формат»

2.1. Базовые форматы экспорта

\- Обязательная поддержка форматов:  
• DOCX — основной формат для обмена и дальнейшей доработки вне системы;  
• PDF — для «финального» просмотра, согласования и архивирования.  
\- Экспорт по умолчанию выполняется из актуальных версий всех разделов документа.

2.2. Структура и оглавление

\- Отражение структуры документа при экспорте:  
• разделы и подразделы отображаются как заголовки (Heading 1/2/3 и т.п.);  
• порядок разделов задаётся order_index и иерархией (parent_section).  
\- Оглавление (TOC):  
• в PROD допускается простое создание TOC на основе заголовков (например, через встроенный механизм Word);  
• обновление TOC оставляется на пользователя (обновление полей в Word).

2.3. Базовые стили и форматирование текста

\- Минимальный набор стилевых правил при экспорте в DOCX:  
• заголовки разделов маппятся на Word-стили Heading 1/2/3;  
• основной текст — стиль Normal или аналогичный базовый;  
• списки и простые таблицы конвертируются в стандартные Word-объекты.  
\- Важно: форматирование должно быть достаточно «чистым», чтобы документ удобно было дорабатывать вручную.

2.4. Экспорт таблиц и фигур (минимально)

\- Таблицы, созданные в редакторе:  
• конвертируются в Word-таблицы с базовым форматированием;  
• допускается отсутствие сложных стилей (слитые ячейки, shading и т.п. на уровне PROD).  
\- Фигуры/графики:  
• на PROD-уровне допустимо экспортировать их как ссылки/подписи (placeholder) либо встроенные изображения, если они загружены.  
\- Подписи к таблицам и рисункам:  
• простое текстовое оформление «Table X: ...», «Figure Y: ...» без автоматической перекрёстной нумерации.

2.5. Экспорт всего документа и отдельных разделов

\- Экспорт всего документа:  
• команда «Экспорт CSR» формирует единый DOCX/PDF с оглавлением и всеми разделами в правильном порядке;  
• файл содержит базовые метаданные (название исследования, номер версии, дату экспорта) на титульной странице или в шапке.  
\- Экспорт отдельных разделов:  
• возможность экспортировать один раздел или поднабор разделов для обмена/ревью;  
• формируется документ с локальным оглавлением (опционально).

2.6. Локализация по языку

\- Учет языка документа:  
• возможность формирования документов на EN/RU и других языках;  
• корректная кодировка и шрифты для кириллицы/латиницы.  
\- В PROD допускается использование единого стилевого набора для всех языков.

2.7. Права доступа и аудит при экспорте

\- Экспорт разрешён только пользователям с соответствующими правами (например, Editor/Owner/RA/QA).  
\- Логирование экспортов:  
• кто, когда, какой документ/версии разделов экспортировал;  
• в какой формат (DOCX/PDF) и с каким именем файла.  
\- Логи экспортов важны для аудита и инспекций.

## 3\. PROD+ — расширенный уровень «Экспорт и формат»

3.1. Интеграция с корпоративными Word-шаблонами

\- Использование корпоративных DOTX-шаблонов спонсора/организации:  
• маппинг внутренних стилей редактора на стили, определённые в шаблоне (Corporate Heading 1, Body Text и т.п.);  
• поддержка титульной страницы, стандартных разделов, шапок/подвалов, логотипов.  
\- Настраиваемые профили экспорта:  
• выбор шаблона при экспорте (например, Sponsor A / Sponsor B / Generic);  
• возможность задать шаблон по умолчанию на уровне организации/проекта.

3.2. Расширенное форматирование и нумерация

\- Таблицы и рисунки:  
• автоматическая нумерация (Table 1-1, Figure 3-2 и т.п.);  
• автоматические подписи через механизмы Word (Caption fields);  
• возможность настроить формат нумерации под требования спонсора или регулятора.  
\- Перекрёстные ссылки:  
• использование полей Word (cross-reference) для ссылок на таблицы, рисунки и разделы;  
• при обновлении полей в Word ссылки автоматически обновляются.

3.3. Продвинутый экспорт PDF

\- PDF c улучшенной структурой:  
• сохранение оглавления с гиперссылками;  
• закладки по заголовкам разделов;  
• корректная печать и визуальное соответствие Word-версии.  
\- Опции:  
• защита от редактирования/копирования (там, где допустимо);  
• водяные знаки (DRAFT/CONFIDENTIAL).

3.4. Мультирегиональные и multi-output профили

\- Разные профили экспорта под регуляторов:  
• EMA/FDA/EAEU — различия в структуре титульной части, формулировках и форматировании;  
• возможность включать/исключать определённые разделы для конкретного регулятора.  
\- Поддержка нескольких «variant документов» на основе одной структуры, но с разными экспортными настройками.

3.5. Экспорт структурированных пакетов

\- Подготовка пакетов для интеграции в eCTD/регуляторные системы:  
• генерация набора файлов с заранее заданными именами и структурой каталогов;  
• сохранение метаданных (версия, дата, автор) в формате, пригодном для внешних систем.  
\- Возможность экспорта связанного набора документов (CSR + Summary + Cover letter drafts) по одному действию.

3.6. Round-trip: импорт изменений из Word (базово)

\- Поддержка сценария:  
• документ был экспортирован в Word, доработан вне системы, затем изменения импортируются обратно;  
• сопоставление разделов по заголовкам/кодам;  
• обновление текста разделов и создание новых версий в системе.  
\- На PROD+ допустим частичный round-trip (с ограничениями по сложному форматированию и track changes).

3.7. Поддержка track changes и комментариев

\- При экспорте в DOCX возможность:  
• включать/выключать track changes по умолчанию;  
• отображать, какие части текста были изменены с момента последней версии.  
\- В перспективе — импорт состояния track changes обратно в систему (отображение предложений/комментариев в веб-интерфейсе).

3.8. Права и контроль версий экспортируемых документов

\- Копирование версия/статута документа в экспортируемый файл:  
• отображение версии (v0.3 draft / v1.0 final) в титульной части;  
• напоминание, что документ черновой, если статус не ready_for_submission.  
\- Контроль доступа:  
• отдельные права на экспорт финальных версий (например, только RA/QA);  
• запрет экспорта с «замороженными» статусами без соответствующих прав.

3.9. Отчётность и аудит по экспортам (Prod+)

\- Расширенные логи:  
• история экспортов по документу и по пользователям;  
• связь экспортов с версиями документа и статусами QC.  
\- Отчётность:  
• выгрузка списка всех экспортов для конкретного CSR/проекта (для internal QA и инспекций).

# Техническая обвязка и “гигиена” — требования к продакшену (Prod и Prod+)

Этот документ описывает, что должно быть реализовано в продакшене по теме «Техническая обвязка и гигиена» для системы подготовки регуляторной и медицинской документации. Речь о фундаменте: конфигурация, логирование, мониторинг, безопасность, тестирование и эксплуатация. Выделены два уровня: базовый PROD и расширенный PROD+ (enterprise).

## 1\. Общая концепция технической “гигиены”

\- Продукт должен быть не только функциональным, но и эксплуатационно надёжным: предсказуемое поведение, понятные логи, контролируемые обновления, понятная реакция на сбои.  
\- Всё, что связано с конфигурацией, доступом к данным, логами, мониторингом и CI/CD, должно быть формализовано и задокументировано.  
\- Модульность: техническая обвязка не должна мешать развитию фич, а поддерживать его.

## 2\. PROD — базовый уровень технической обвязки

2.1. Конфигурация и окружения

\- Чёткое разделение окружений:  
• dev / test / prod (минимум);  
• отдельные базы данных и внешние сервисы для prod.  
\- Конфигурация через переменные окружения и/или .env-файлы:  
• адреса БД, ключи внешних API, настройки кэша;  
• отсутствие секретов в git-репозитории.  
\- Документация по настройке окружений и переменным.

2.2. Логирование (application logs)

\- Базовое структурированное логирование backend-сервисов:  
• уровень логов минимум INFO/ERROR, отдельно DEBUG для dev;  
• логирование ключевых событий: логин, операции с документами, ошибки API.  
\- Формат логов пригодный для агрегации (JSON или чётко структурированный текст).  
\- Логи ошибок должны содержать stack trace (для dev/stage) и correlation id (для prod).

2.3. Обработка ошибок и UX при сбоях

\- Централизованный обработчик ошибок на backend:  
• различение 4xx и 5xx;  
• единый формат ответа об ошибке (код, сообщение, correlation id);  
• отсутствие утечки внутренних деталей (stack trace) во внешний API response.  
\- На фронте:  
• дружелюбные сообщения об ошибках («что делать дальше»);  
• глобальный обработчик для сетевых/серверных ошибок.

2.4. Миграции БД и управление схемой

\- Использование Alembic или аналогичного инструмента миграций:  
• все изменения схемы оформляются миграциями;  
• запрет «ручных» изменений в продовой базе.  
\- Практика:  
• миграции проходят на dev/test перед prod;  
• ведётся история миграций в репозитории и в базе.

2.5. Тестирование и базовый CI

\- Минимальный набор автотестов:  
• unit-тесты для ключевой бизнес-логики (RAG, QC-правила, шаблоны);  
• несколько интеграционных тестов на критические API (auth, CRUD по исследованиям, сохранение текстов).  
\- Базовый CI-пайплайн:  
• запуск тестов и линтеров при push/merge;  
• блокировка merge при падении тестов.  
\- Код-стайл и линтинг (flake8/black/isort для Python, eslint/prettier для фронта).

2.6. Безопасность (минимум)

\- Аутентификация и хранение паролей:  
• надёжный password hashing (bcrypt/argon2);  
• запрет хранения паролей в открытом виде.  
\- Авторизация:  
• проверка прав на уровне API (пользователь ↔ проекты ↔ документы);  
• защита от доступа к чужим данным по id.  
\- Транспорт:  
• работа через HTTPS (терминация на обратном прокси/Ingress), никаких HTTP в проде.  
\- Базовая защита от типичных ошибок OWASP (CSRF, XSS для фронта, ограничение размеров запросов).

2.7. Резервное копирование и восстановление (backup & restore)

\- Регулярные бэкапы:  
• базы данных;  
• файлового/объектного хранилища документов-источников.  
\- Минимум:  
• периодичность бэкапов (например, ежедневно);  
• скрипт/процедура восстановления на отдельном стенде.  
\- Документация по процедуре восстановления (RTO/RPO на уровне зрелого здравого смысла).

2.8. Мониторинг базового уровня

\- Технический мониторинг:  
• доступность сервиса (health-check endpoint);  
• базовые метрики: использование CPU/RAM/диска, ошибки 5xx.  
\- Алерты:  
• простейшая система уведомлений (почта/чат) при падении сервиса или всплеске ошибок.

## 3\. PROD+ — расширенный уровень технической обвязки

3.1. Наблюдаемость (observability): логи, метрики, трассировка

\- Централизованная система логирования:  
• агрегация логов (ELK/Opensearch, Loki и т.п.);  
• дашборды по ключевым событиям (ошибки, авторизация, операции с документами).  
\- Метрики приложения:  
• бизнес-метрики (число сессий, операций редактирования, вызовов AI);  
• технические (latency, rate, error rate по эндпоинтам).  
\- Distributed tracing:  
• трассировка запросов через backend, внешние сервисы, БД (Jaeger/Tempo и т.п.);  
• correlation id, проходящий через все слои.

3.2. Полноценный CI/CD-пайплайн

\- CI:  
• прогон unit/integration тестов и линтеров;  
• сборка образов (Docker) с версионированием.  
\- CD:  
• автоматический деплой на dev/test;  
• контролируемый деплой на prod (manual approval, canary/blue-green при необходимости).  
\- Проверка миграций БД и health-check после деплоя.

3.3. Управление секретами и конфигурацией

\- Secrets management:  
• хранение секретов в Vault/KMS/секретах Kubernetes/аналогах;  
• ротация ключей и паролей (schedule или по событию).  
\- Конфигурация per environment/tenant:  
• возможность задать отдельные настройки для разных клиентов/организаций;  
• строгий контроль того, что прод-конфиг не смешивается с dev/test.

3.4. Безопасность enterprise-уровня

\- Hardened security:  
• WAF/Reverse proxy с базовой защитой от типичных атак;  
• rate limiting и защита от brute force по логину;  
• контроль размеров загрузок и ограничение по типам файлов.  
\- Identity:  
• SSO (SAML/OIDC) и интеграция с корпоративным IdP;  
• управление ролями и группами через IdP (SCIM или аналог).

3.5. Масштабируемость и производительность

\- Архитектура, поддерживающая горизонтальное масштабирование (контейнеры, Kubernetes/аналог):  
• stateless backend, sticky sessions по возможности не требуются;  
• вынос stateful компонентов (БД, storage) в управляемые сервисы.  
\- Performance testing:  
• нагрузочные тесты на типичные сценарии (редактирование, AI-вызовы, QC-run);  
• SLA/SLO по времени ответа для ключевых операций.

3.6. Управление фичами (feature flags)

\- Система feature flags:  
• возможность включать новые функции для ограниченной группы пользователей/проектов;  
• поэтапный rollout без отдельного релиза.  
\- Отдельные флаги для рискованных или экспериментальных возможностей (например, новые AI-модели).

3.7. Управление данными и privacy

\- Политики хранения данных:  
• retention для логов, технических артефактов, временных файлов;  
• архивирование и удаление старых проектов по политике организации.  
\- Работа с чувствительными данными:  
• маскирование/анонимизация при необходимости (особенно для non-prod окружений);  
• запрет использования реальных PHI/PII в dev/test.

3.8. Disaster recovery и устойчивость

\- План восстановления после аварий:  
• определены RPO/RTO для базы и файлов;  
• регулярная проверка восстановления из бэкапов.  
\- Избыточность:  
• репликация БД (read-replica/HA);  
• гео-резервирование (при необходимости для крупных клиентов).

3.9. Документация, runbook и операционные процессы

\- Техническая документация:  
• архитектура системы, схемы компонентов;  
• описание API, конфигурации, зависимостей.  
\- Runbooks для on-call/поддержки:  
• что делать при росте 5xx, падении БД, отказе storage;  
• типовые шаги диагностики и восстановления.  
\- Операционные процессы:  
• регулярные обновления зависимостей и библиотек (security patches);  
• контроль качества и безопасности перед релизами.

# Дополнительные компоненты для продакшена

Этот документ описывает дополнительные блоки функциональности, которые стоит включить в продовую версию системы помимо уже сформулированных разделов (пользователи/проекты, документы-источники, структура и редактор, AI-ассистент, RAG, Consistency/QC, экспорт и формат, техническая гигиена).

## 1\. Коллаборация и коммуникации

1.1. Комментарии и обсуждения

\- Комментарии к документу, разделу и конкретному фрагменту текста (inline comments).  
\- Thread’ы комментариев с ответами.  
\- Статусы комментария: open / resolved.  
\- Упоминания пользователей (@user) с уведомлениями.

1.2. Уведомления

\- In-app уведомления о:  
• новых комментариях к моим разделам/проектам;  
• назначенных Issues QC или задачах;  
• изменении статуса документа (например, «готов к ревью»);  
• завершении AI/QC-run.  
\- Email-уведомления (конфигурируемые по типам событий).

1.3. Простая система задач

\- Задачи, привязанные к проекту, документу, разделу или Issue QC.  
\- Поля задачи: заголовок, исполнитель, срок, статус (todo / in progress / done).  
\- Лёгкая доска задач по проекту (канбан-вид или список с фильтрами).

## 2\. Поиск, навигация и knowledge management

2.1. Глобальный поиск

\- Поиск по:  
• проектам/исследованиям (по коду, названию, спонсору);  
• документам (CSR, протоколы, шаблоны);  
• разделам по заголовкам;  
• Issues QC.  
\- Фильтры: спонсор, фаза, показание, статус, язык.

2.2. Поиск по содержимому

\- Full-text по содержимому CSR/протоколов/шаблонов.  
\- Быстрый переход к разделу по фразе/слову (jump to section).

2.3. Глоссарий и справочники

\- Единый словарь терминов:  
• названия препаратов, показаний, популяций;  
• preferred wording для типовых формулировок;  
• стандартизированные сокращения.  
\- Интеграция с редактором: подсказки и авто-подстановка терминов.

## 3\. Интеграции и открытый API

3.1. REST/GraphQL API

\- Документированный API для:  
• чтения проектов, документов, Issues, QC-результатов;  
• запуска QC/AI/экспортов;  
• интеграции с BI и внутренними системами заказчика.

3.2. Webhooks и события

\- Webhooks при ключевых событиях:  
• изменение статуса документа;  
• завершение QC-run или крупного AI-run;  
• создание/изменение Issues.  
\- Интеграция со Slack/Teams/email/таск-трекерами через эти webhooks.

3.3. Интеграции с внешними системами

\- EDC/статистические системы — для TLF/golden-data.  
\- DMS/eTMF (Veeva и аналоги) — синхронизация статусов и ссылок на финальные документы.  
\- CTMS — импорт/синхронизация метаданных по исследованиям.  
\- Identity/SSO — частично покрыто в технической гигиене, но важно как интеграционный блок.

## 4\. Админка и конфигурация продукта/тенанта

4.1. Администраторская панель

\- Управление организациями/тенантами и спонсорами.  
\- Управление пользователями и ролями (в т.ч. массовые операции).  
\- Настройка шаблонов:  
• структуры документов;  
• текстовых шаблонов;  
• prompt-шаблонов для AI;  
• QC rule packs.

4.2. Конфигурация фич и лимитов

\- Включение/отключение модулей per-организация:  
• AI-ассистент;  
• QC-advanced;  
• расширенный RAG;  
• расширенный экспорт.  
\- Настройки лимитов:  
• максимум проектов, пользователей;  
• объём хранилища;  
• квоты на AI-вызовы и QC-run.

## 5\. Лицензирование, биллинг и учёт использования

5.1. Модель лицензирования

\- Определение коммерческой модели:  
• per-user (seat);  
• per-project;  
• per-usage (AI-вызовы, QC-run, объём хранения);  
• гибридные модели.  
\- Ролевой состав лицензий (например, Writer/Reviewer/Admin).

5.2. Учёт использования (usage tracking)

\- Сбор метрик использования:  
• активные пользователи и их роли;  
• количество проектов и документов;  
• количество AI-вызовов и QC-run;  
• объём данных в хранилище.  
\- Отчёты для:  
• администратора организации;  
• собственного биллинга и контрактов.

5.3. Интеграция с внешним биллингом (по необходимости)

\- Экспорт usage-данных в финансовую систему.  
\- API/отчёты для выставления счетов.

## 6\. Onboarding, обучение и поддержка пользователей

6.1. Встроенный onboarding

\- Guided tour для новых пользователей:  
• базовый walkthrough по ключевым экранам (проекты, редактор, AI, QC);  
• подсказки «что делать дальше» при пустом состоянии (нет проектов/документов).  
\- Контекстные подсказки (tooltips) для сложных элементов интерфейса.

6.2. Документация и база знаний

\- Встроенный раздел «Help / Knowledge base»:  
• как создавать проект;  
• как работать с шаблонами, AI, QC;  
• частые вопросы (FAQ).  
\- Ссылки на внешние материалы: видео, гайды, best practices.

6.3. Demo / sandbox режим

\- Отдельный «демо-проект» с анонимизированными данными.  
\- Возможность безопасно тестировать функции без риска повредить реальные исследования.  
\- Режим презентации для пресейлов/обучения.

## 7\. Право, комплаенс и управление данными

7.1. Data governance и privacy

\- Механизмы анонимизации/псевдонимизации данных для non-prod окружений.  
\- Политики удаления данных:  
• полное удаление проекта/организации по запросу;  
• экспорт данных клиента (data portability).  
\- Настройки «sensitive mode» для клиентов с жёсткими требованиями (минимизация логирования payload-ов, строгий контроль доступа).

7.2. Согласия и политики

\- Учёт пользовательских соглашений и политик:  
• фиксация факта и даты принятия Terms & Conditions, Privacy Policy;  
• версионирование документов политик.  
\- Возможность выгрузить информацию для аудита по конкретному пользователю/организации.

## 8\. Инструменты поддержки и операционная работа

8.1. Support view

\- Специальный интерфейс для команды поддержки:  
• просмотр состояния организации/тенанта (настройки, лимиты, включённые фичи);  
• быстрый поиск по пользователям, проектам, ошибкам;  
• просмотр логов и метрик по конкретному клиенту.

8.2. Feature flags-консоль

\- UI для управления feature flags:  
• включение/отключение функций на уровне организации/проекта;  
• фазовый rollout новых возможностей.  
\- История изменений фич-флагов.

8.3. Инструменты миграции и импорта

\- Импорт существующих данных:  
• CSR/Word-документы (частичная автоматическая структура + ручная доразметка);  
• Excel-файлы с метаданными исследований;  
• выгрузки из старых систем клиента.  
\- Подготовка скриптов/утилит для миграции при онбординге новых клиентов.