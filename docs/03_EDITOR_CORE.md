# 03. Структура Документа и Редактор (Core)

## 1. Модель данных
*   **Document Structure:** Дерево `deliverable_sections` (соответствует пользовательскому шаблону на основе идеального шаблона).
*   **Content:** Хранится в HTML (совместимо с Tiptap) в поле `content_html`.
*   **Linkage:** Каждая секция связана с `custom_section_id` (пользовательская секция шаблона) и содержит массив `used_source_section_ids` (ID исходных секций, использованных для генерации).

## 2. Workflow статусов секций
Секции готовых документов (`deliverable_sections`) проходят через следующий workflow:

*   **`empty`** - пустая секция (только что создана)
*   **`draft_ai`** - секция сгенерирована AI (черновик)
*   **`in_progress`** - секция в процессе редактирования пользователем
*   **`review`** - секция на проверке
*   **`approved`** - секция одобрена

## 3. Редактор (Tiptap) + AI Actions
*   **AI Panel:**
    *   Кнопка "Generate Draft" для раздела.
    *   Вызывает Python API `POST /generate` с параметрами:
        - `project_id` - UUID проекта
        - `target_section_id` - UUID секции deliverable для генерации
        - `deliverable_id` - UUID документа (deliverable)
    *   API использует сервис `Writer.generate_section()` для генерации секции.
    *   Отображает статус генерации ("Reading Protocol...", "Analyzing Tables...", "Writing...").
    *   После генерации статус секции меняется на `draft_ai`.
*   **Review Mode:**
    *   Пользователь видит сгенерированный текст.
    *   Слева/Справа подсвечивается *источник* (исходная Markdown-таблица или текст из Протокола), использованный для генерации.
    *   Источники определяются через массив `used_source_section_ids` в секции.
    *   При генерации используются только актуальные версии документов (`is_current_version = TRUE`).

## 4. Блокировки секций
*   Механизм блокировки предотвращает одновременное редактирование:
    *   `locked_by_user_id` - ID пользователя, заблокировавшего секцию
    *   `locked_at` - время блокировки
*   Автоматическая разблокировка через функцию `unlock_stale_deliverable_sections()` для зависших блокировок.

## 5. История изменений (Audit Trail)
*   Каждое изменение секции автоматически создает запись в `deliverable_section_history`:
    *   `content_snapshot` - снимок HTML контента на момент изменения
    *   `changed_by_user_id` - пользователь, внесший изменение
    *   `change_reason` - причина изменения (например, "AI generation", "Manual edit")
*   Триггер `deliverable_section_history_trigger` автоматически создает записи истории при изменении контента или статуса.

## 6. Работа с Таблицами
*   Сгенерированные таблицы вставляются в редактор как нативные Tiptap-таблицы.
*   Пользователь может редактировать их вручную.

## 7. Виртуализация списка секций
*   **Компонент:** `components/deliverable-editor-list.tsx`
*   **Технология:** `react-virtuoso` для виртуализации рендеринга
*   **Оптимизация производительности:**
    *   Рендеринг только видимых секций в viewport
    *   Автоматическая обработка динамических высот редакторов
    *   Увеличенный overscan для плавной прокрутки
*   **Особенности:**
    *   Использует `defaultItemHeight={300}` как подсказку для начального рендеринга
    *   Virtuoso автоматически измеряет и корректирует высоты элементов
    *   Поддержка динамического изменения высоты редакторов при редактировании

## 8. Управление состоянием редакторов
*   **Store:** `lib/stores/section-editor-store.ts` (Zustand)
*   **Функциональность:**
    *   Хранение несохраненного контента секций в памяти
    *   Отслеживание состояния "грязности" (изменен ли контент)
    *   Сохранение состояния при размонтировании компонентов
*   **Компонент секции:** `components/section-editor.tsx`
    *   Интеграция с Tiptap Editor
    *   Автоматическое сохранение в store при изменении
    *   Автосохранение в БД через 2 секунды после последнего изменения
    *   Восстановление несохраненного контента при повторном монтировании
*   **Преимущества:**
    *   Сохранение состояния редакторов при скролле (не теряется фокус и несохраненные изменения)
    *   Плавная работа с большим количеством секций
    *   Автоматическое управление жизненным циклом редакторов